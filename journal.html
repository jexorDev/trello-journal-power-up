<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
  </head>
  <style>
    select{
        height: 500px;
        width: 500px;
    }
  </style>
  <body>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/dayOfYear.js"></script>
    <div id="journal">
        <h1>Journal</h1>
    </h1>
    <script src="/journal.js"></script>

    <script type="module">
       async function getCardComments(apiKey, token, cardId) {
          try {
            const response = await fetch(`https://api.trello.com/1/cards/${cardId}/actions?filter=commentCard&key=${apiKey}&token=${token}`);
            const data = await response.json();
            return data;
          } catch (error) {
            console.error("Error fetching data:", error);
          }
        }

        function isSameDay(firstDate, secondDate) {
          return dayjs(firstDate).dayOfYear() === dayjs(secondDate).dayOfYear()
        }

        dayjs.extend(window.dayjs_plugin_utc);
        dayjs.extend(window.dayjs_plugin_dayOfYear);
        
        var t = window.TrelloPowerUp.iframe({
  appKey: "ab51919adb28cfb83270a0d6ee991d38",
  appName: "activity-journal",
  appAuthor: "doostin"});

          let apiToken = "";
        const cards = t.arg("cards");
        let goalMap = new Map();        
        for (var i = 0; i < cards.length; i++){
          if (!isSameDay(cards[i]["dateLastActivity"], dayjs().utc())) {
            continue;
          }

          if (cards[i]["labels"] !== undefined) {
            for (var j = 0; j < cards[i]["labels"].length; j++) {

              const appKey = "ab51919adb28cfb83270a0d6ee991d38";

              if (apiToken === "") {
                await t.getRestApi().getToken().then((token) => {
                  apiToken = token;
                });

              }
              
              let activityEntriesJson = "";
              await getCardComments(appKey, apiToken, cards[i]["id"]).then((data) => activityEntriesJson = data);
              const activityEntries = [];

              for (var commentIndex = 0; commentIndex < activityEntriesJson.length; commentIndex++) {
                if (!isSameDay(activityEntriesJson[commentIndex]["date"], dayjs().utc())) {
                  continue;
                }

                activityEntries.push(activityEntriesJson[commentIndex]["data"]["text"]);
              }

              const goalName = cards[i]["labels"][j]["name"];

              const goalActivity = {
                activityName: cards[i]["name"],
                entries: activityEntries,
                dateLastActivity: cards[i]["dateLastActivity"]
              }

              if (goalMap.has(goalName)) {
                goalMap.set(goalName, [...goalMap.get(goalName), goalActivity]);

              } else {
                goalMap.set(goalName, [goalActivity]);

              }
              

            }
            
          }          
        }

        goalMap.forEach(function(value, key, map) {
          
          document.write("<br><span class='goal-name'>" + key + "</span>");

          for (var i = 0; i < map.get(key).length; i++) {
            document.write("<br>" + value[i]["activityName"] + " " + value[i]["dateLastActivity"]);

            for (var j = 0; j < value[i]["entries"].length; j++) {
              document.write("<br>" + value[i]["entries"][j]);
            }
            //console.log(new Date(value[i]["dateLastActivity"]));

          }
        })

    </script>
  </body>
  <style>
    .goal-name {
      font-weight: bold;
    }
  </style>
</html>
